import{d as M,q as ue,ih as _,hA as he,sw as j,sx as De,G as y,iI as O,J as E,ir as Re,X as w,sy as Ge,ix as m,Y as C,iK as v,ad as z,hI as X,cV as $,bU as G,sz as me,sA as x,il as Q,y as W,b7 as Ie,b4 as le,i_ as fe,z as A,_ as U,e as u,k as Te,kR as Z,hD as _e,ic as k,id as D,iH as P,sB as be,ar as Me,iG as we,bT as Ue,eQ as xe,ev as F,kO as N,sC as We,na as ke,st as Pe,ib as L,ik as V,x as B,sD as H,U as l,en as pe,is as ve,ij as Ee,B as Fe,bD as ee,sE as te,sF as p,O as Ne,f as ge,s as Se,p as Le,iW as J,j2 as Ce,sv as Ve,dO as ye,nH as Be,R as He,ii as Y,ia as Ye,ie,n3 as re,iv as qe,n9 as se,nI as Ke,sG as S,sH as f,sI as oe,ag as ze,nD as $e,c as Qe,kV as Je,l as je,nd as Xe,aG as Ze,aH as et}from"./index-C7iXF2w2.js";function ne(h,e,t){const i=h.get(M);const r=h.get(ue);const s=tt(e,t,i,r);if(s instanceof Promise){return s.then(n=>ae(n,e,t,i))}return ae(s,e,t,i)}function ae(h,e,t,i){let r=void 0;if(i.activeGroup!==h&&e.options&&!e.options.inactive&&e.options.preserveFocus&&typeof e.options.activation!=="number"&&t!==he){r=Re.ACTIVATE}return[h,r]}function tt(h,e,t,i){let r;const s=_(h)?h.editor:h;const n=h.options;if(e&&typeof e!=="number"){r=e}else if(typeof e==="number"&&e>=0){r=t.getGroup(e)}else if(e===he){const o=j(i);let a=t.findGroup({direction:o});if(!a||T(a,s)){a=t.addGroup(t.activeGroup,o)}r=a}else if(e===De){r=t.createAuxiliaryEditorPart().then(o=>o.activeGroup)}else if(!n||typeof n.index!=="number"){const o=t.getGroups(y.MOST_RECENTLY_ACTIVE);if(n?.revealIfVisible){for(const a of o){if(it(a,s)){r=a;break}}}if(!r){if(n?.revealIfOpened||i.getValue("workbench.editor.revealIfOpen")||O(s)&&s.hasCapability(E.Singleton)){let a=void 0;let d=void 0;for(const c of o){if(Ae(c,s)){if(!d){d=c}if(!a&&c.isActive(s)){a=c}}if(d&&a){break}}r=a||d}}}if(!r){let o=t.activeGroup;if(T(o,s)){for(const a of t.getGroups(y.MOST_RECENTLY_ACTIVE)){if(T(a,s)){continue}o=a;break}if(T(o,s)){r=t.addGroup(o,j(i))}else{r=o}}else{r=o}}return r}function T(h,e){if(!h.isLocked){return false}if(Ae(h,e)){return false}return true}function it(h,e){if(!h.activeEditor){return false}return h.activeEditor.matches(e)}function Ae(h,e){for(const t of h.editors){if(t.matches(e)){return true}}return false}var R;let q=class st extends w{static{R=this}static{this.STORAGE_KEY="editors.mru"}get count(){return this.mostRecentEditorsMap.size}get editors(){return[...this.mostRecentEditorsMap.values()]}hasEditor(e){const t=this.editorsPerResourceCounter.get(e.resource);return t?.has(this.toIdentifier(e))??false}hasEditors(e){return this.editorsPerResourceCounter.has(e)}toIdentifier(e,t){if(typeof e!=="string"){return this.toIdentifier(e.typeId,e.editorId)}if(t){return`${e}/${t}`}return e}constructor(e,t,i){super();this.editorGroupService=t;this.storageService=i;this.keyMap=new Map;this.mostRecentEditorsMap=new Ge;this.editorsPerResourceCounter=new m;this._onDidMostRecentlyActiveEditorsChange=this._register(new C);this.onDidMostRecentlyActiveEditorsChange=this._onDidMostRecentlyActiveEditorsChange.event;this.editorGroupsContainer=e??t;this.isScoped=!!e;this.registerListeners();this.loadState()}registerListeners(){this._register(this.editorGroupsContainer.onDidAddGroup(e=>this.onGroupAdded(e)));this._register(this.editorGroupService.onDidChangeEditorPartOptions(e=>this.onDidChangeEditorPartOptions(e)));this._register(this.storageService.onWillSaveState(()=>this.saveState()))}onGroupAdded(e){const t=e.getEditors(v.MOST_RECENTLY_ACTIVE);for(let i=t.length-1;i>=0;i--){this.addMostRecentEditor(e,t[i],false,true)}if(this.editorGroupsContainer.activeGroup===e&&e.activeEditor){this.addMostRecentEditor(e,e.activeEditor,true,false)}this.registerGroupListeners(e)}registerGroupListeners(e){const t=new z;t.add(e.onDidModelChange(i=>{switch(i.kind){case X.GROUP_ACTIVE:{if(this.editorGroupsContainer.activeGroup===e&&e.activeEditor){this.addMostRecentEditor(e,e.activeEditor,true,false)}break}case X.EDITOR_OPEN:{if(i.editor){this.addMostRecentEditor(e,i.editor,false,true);this.ensureOpenedEditorsLimit({groupId:e.id,editor:i.editor},e.id)}break}}}));t.add(e.onDidCloseEditor(i=>{this.removeMostRecentEditor(e,i.editor)}));t.add(e.onDidActiveEditorChange(i=>{if(i.editor){this.addMostRecentEditor(e,i.editor,this.editorGroupsContainer.activeGroup===e,false)}}));$.once(e.onWillDispose)(()=>G(t))}onDidChangeEditorPartOptions(e){if(!me(e.newPartOptions.limit,e.oldPartOptions.limit)){const t=this.editorGroupsContainer.activeGroup;let i=void 0;if(t.activeEditor){i={editor:t.activeEditor,groupId:t.id}}this.ensureOpenedEditorsLimit(i)}}addMostRecentEditor(e,t,i,r){const s=this.ensureKey(e,t);const n=this.mostRecentEditorsMap.first;if(i||!n){this.mostRecentEditorsMap.set(s,s,n?x.AsOld:void 0)}else{this.mostRecentEditorsMap.set(s,s,x.AsOld);this.mostRecentEditorsMap.set(n,n,x.AsOld)}if(r){this.updateEditorResourcesMap(t,true)}this._onDidMostRecentlyActiveEditorsChange.fire()}updateEditorResourcesMap(e,t){let i=void 0;let r=void 0;let s=void 0;if(e instanceof Q){i=e.primary.resource;r=e.primary.typeId;s=e.primary.editorId}else{i=e.resource;r=e.typeId;s=e.editorId}if(!i){return}const n=this.toIdentifier(r,s);if(t){let o=this.editorsPerResourceCounter.get(i);if(!o){o=new Map;this.editorsPerResourceCounter.set(i,o)}o.set(n,(o.get(n)??0)+1)}else{const o=this.editorsPerResourceCounter.get(i);if(o){const a=o.get(n)??0;if(a>1){o.set(n,a-1)}else{o.delete(n);if(o.size===0){this.editorsPerResourceCounter.delete(i)}}}}}removeMostRecentEditor(e,t){this.updateEditorResourcesMap(t,false);const i=this.findKey(e,t);if(i){this.mostRecentEditorsMap.delete(i);const r=this.keyMap.get(e.id);if(r&&r.delete(i.editor)&&r.size===0){this.keyMap.delete(e.id)}this._onDidMostRecentlyActiveEditorsChange.fire()}}findKey(e,t){const i=this.keyMap.get(e.id);if(!i){return void 0}return i.get(t)}ensureKey(e,t){let i=this.keyMap.get(e.id);if(!i){i=new Map;this.keyMap.set(e.id,i)}let r=i.get(t);if(!r){r={groupId:e.id,editor:t};i.set(t,r)}return r}async ensureOpenedEditorsLimit(e,t){if(!this.editorGroupService.partOptions.limit?.enabled||typeof this.editorGroupService.partOptions.limit.value!=="number"||this.editorGroupService.partOptions.limit.value<=0){return}const i=this.editorGroupService.partOptions.limit.value;if(this.editorGroupService.partOptions.limit?.perEditorGroup){if(typeof t==="number"){const r=this.editorGroupsContainer.getGroup(t);if(r){await this.doEnsureOpenedEditorsLimit(i,r.getEditors(v.MOST_RECENTLY_ACTIVE).map(s=>({editor:s,groupId:t})),e)}}else{for(const r of this.editorGroupsContainer.groups){await this.ensureOpenedEditorsLimit(e,r.id)}}}else{await this.doEnsureOpenedEditorsLimit(i,[...this.mostRecentEditorsMap.values()],e)}}async doEnsureOpenedEditorsLimit(e,t,i){let r;if(this.editorGroupService.partOptions.limit?.excludeDirty){r=t.filter(({editor:a})=>{if(a.isDirty()&&!a.isSaving()||a.hasCapability(E.Scratchpad)){return false}return true})}else{r=t}if(e>=r.length){return}const s=r.reverse().filter(({editor:a,groupId:d})=>{if(a.isDirty()&&!a.isSaving()||a.hasCapability(E.Scratchpad)){return false}if(i&&a===i.editor&&d===i.groupId){return false}if(this.editorGroupsContainer.getGroup(d)?.isSticky(a)){return false}return true});let n=r.length-e;const o=new Map;for(const{groupId:a,editor:d}of s){let c=o.get(a);if(!c){c=[];o.set(a,c)}c.push(d);n--;if(n===0){break}}for(const[a,d]of o){const c=this.editorGroupsContainer.getGroup(a);if(c){await c.closeEditors(d,{preserveFocus:true})}}}saveState(){if(this.isScoped){return}if(this.mostRecentEditorsMap.isEmpty()){this.storageService.remove(R.STORAGE_KEY,W.WORKSPACE)}else{this.storageService.store(R.STORAGE_KEY,JSON.stringify(this.serialize()),W.WORKSPACE,Ie.MACHINE)}}serialize(){const e=le.as(fe.EditorFactory);const t=[...this.mostRecentEditorsMap.values()];const i=new Map;return{entries:A(t.map(({editor:r,groupId:s})=>{const n=this.editorGroupsContainer.getGroup(s);if(!n){return void 0}let o=i.get(n);if(!o){o=n.getEditors(v.SEQUENTIAL).filter(d=>{const c=e.getEditorSerializer(d);return c?.canSerialize(d)});i.set(n,o)}const a=o.indexOf(r);if(a===-1){return void 0}return{groupId:s,index:a}}))}}async loadState(){if(this.editorGroupsContainer===this.editorGroupService.mainPart||this.editorGroupsContainer===this.editorGroupService){await this.editorGroupService.whenReady}let e=false;if(!this.isScoped){const t=this.storageService.get(R.STORAGE_KEY,W.WORKSPACE);if(t){e=true;this.deserialize(JSON.parse(t))}}if(!e){const t=this.editorGroupsContainer.getGroups(y.MOST_RECENTLY_ACTIVE);for(let i=t.length-1;i>=0;i--){const r=t[i];const s=r.getEditors(v.MOST_RECENTLY_ACTIVE);for(let n=s.length-1;n>=0;n--){this.addMostRecentEditor(r,s[n],true,true)}}}for(const t of this.editorGroupsContainer.groups){this.registerGroupListeners(t)}}deserialize(e){const t=[];for(const{groupId:i,index:r}of e.entries){const s=this.editorGroupsContainer.getGroup(i);if(!s){continue}const n=s.getEditorByIndex(r);if(!n){continue}const o=this.ensureKey(s,n);t.push([o,o]);this.updateEditorResourcesMap(n,true)}this.mostRecentEditorsMap.fromJSON(t)}};q=R=U([u(1,M),u(2,Te)],q);var K;let de=K=class ot extends w{constructor(e,t,i,r,s,n,o,a,d,c,g){super();this.editorGroupService=t;this.instantiationService=i;this.fileService=r;this.configurationService=s;this.contextService=n;this.uriIdentityService=o;this.editorResolverService=a;this.workspaceTrustRequestService=d;this.hostService=c;this.textEditorService=g;this._onDidActiveEditorChange=this._register(new C);this.onDidActiveEditorChange=this._onDidActiveEditorChange.event;this._onDidVisibleEditorsChange=this._register(new C);this.onDidVisibleEditorsChange=this._onDidVisibleEditorsChange.event;this._onDidEditorsChange=this._register(new C);this.onDidEditorsChange=this._onDidEditorsChange.event;this._onWillOpenEditor=this._register(new C);this.onWillOpenEditor=this._onWillOpenEditor.event;this._onDidCloseEditor=this._register(new C);this.onDidCloseEditor=this._onDidCloseEditor.event;this._onDidOpenEditorFail=this._register(new C);this.onDidOpenEditorFail=this._onDidOpenEditorFail.event;this._onDidMostRecentlyActiveEditorsChange=this._register(new C);this.onDidMostRecentlyActiveEditorsChange=this._onDidMostRecentlyActiveEditorsChange.event;this.lastActiveEditor=void 0;this.activeOutOfWorkspaceWatchers=new m;this.closeOnFileDelete=false;this.editorGroupsContainer=e??t;this.editorsObserver=this._register(this.instantiationService.createInstance(q,this.editorGroupsContainer));this.onConfigurationUpdated();this.registerListeners()}createScoped(e,t){return t.add(new K(e==="main"?this.editorGroupService.mainPart:e,this.editorGroupService,this.instantiationService,this.fileService,this.configurationService,this.contextService,this.uriIdentityService,this.editorResolverService,this.workspaceTrustRequestService,this.hostService,this.textEditorService))}registerListeners(){if(this.editorGroupsContainer===this.editorGroupService.mainPart||this.editorGroupsContainer===this.editorGroupService){this.editorGroupService.whenReady.then(()=>this.onEditorGroupsReady())}else{this.onEditorGroupsReady()}this._register(this.editorGroupsContainer.onDidChangeActiveGroup(e=>this.handleActiveEditorChange(e)));this._register(this.editorGroupsContainer.onDidAddGroup(e=>this.registerGroupListeners(e)));this._register(this.editorsObserver.onDidMostRecentlyActiveEditorsChange(()=>this._onDidMostRecentlyActiveEditorsChange.fire()));this._register(this.onDidVisibleEditorsChange(()=>this.handleVisibleEditorsChange()));this._register(this.fileService.onDidRunOperation(e=>this.onDidRunFileOperation(e)));this._register(this.fileService.onDidFilesChange(e=>this.onDidFilesChange(e)));this._register(this.configurationService.onDidChangeConfiguration(e=>this.onConfigurationUpdated(e)))}onEditorGroupsReady(){for(const e of this.editorGroupsContainer.groups){this.registerGroupListeners(e)}if(this.activeEditor){this.doHandleActiveEditorChangeEvent();this._onDidVisibleEditorsChange.fire()}}handleActiveEditorChange(e){if(e!==this.editorGroupsContainer.activeGroup){return}if(!this.lastActiveEditor&&!e.activeEditor){return}this.doHandleActiveEditorChangeEvent()}doHandleActiveEditorChangeEvent(){const e=this.editorGroupsContainer.activeGroup;this.lastActiveEditor=e.activeEditor??void 0;this._onDidActiveEditorChange.fire()}registerGroupListeners(e){const t=new z;t.add(e.onDidModelChange(i=>{this._onDidEditorsChange.fire({groupId:e.id,event:i})}));t.add(e.onDidActiveEditorChange(()=>{this.handleActiveEditorChange(e);this._onDidVisibleEditorsChange.fire()}));t.add(e.onWillOpenEditor(i=>{this._onWillOpenEditor.fire(i)}));t.add(e.onDidCloseEditor(i=>{this._onDidCloseEditor.fire(i)}));t.add(e.onDidOpenEditorFail(i=>{this._onDidOpenEditorFail.fire({editor:i,groupId:e.id})}));$.once(e.onWillDispose)(()=>{G(t)})}handleVisibleEditorsChange(){const e=new Z;for(const t of this.visibleEditors){const i=_e(A([k.getCanonicalUri(t,{supportSideBySide:D.PRIMARY}),k.getCanonicalUri(t,{supportSideBySide:D.SECONDARY})]),r=>r.toString());for(const r of i){if(this.fileService.hasProvider(r)&&!this.contextService.isInsideWorkspace(r)){e.add(r)}}}for(const t of this.activeOutOfWorkspaceWatchers.keys()){if(!e.has(t)){G(this.activeOutOfWorkspaceWatchers.get(t));this.activeOutOfWorkspaceWatchers.delete(t)}}for(const t of e.keys()){if(!this.activeOutOfWorkspaceWatchers.get(t)){const i=this.fileService.watch(t);this.activeOutOfWorkspaceWatchers.set(t,i)}}}async onDidRunFileOperation(e){if(e.isOperation(P.MOVE)){this.handleMovedFile(e.resource,e.target.resource)}if(e.isOperation(P.DELETE)||e.isOperation(P.MOVE)){this.handleDeletedFile(e.resource,false,e.target?e.target.resource:void 0)}}onDidFilesChange(e){if(e.gotDeleted()){this.handleDeletedFile(e,true)}}async handleMovedFile(e,t){for(const i of this.editorGroupsContainer.groups){const r=[];for(const s of i.editors){const n=s.resource;if(!n||!this.uriIdentityService.extUri.isEqualOrParent(n,e)){continue}let o;if(this.uriIdentityService.extUri.isEqual(e,n)){o=t}else{const c=be(n.path,e.path,this.uriIdentityService.extUri.ignorePathCasing(n));o=Me(t,n.path.substr(c+e.path.length+1))}const a=await s.rename(i.id,o);if(!a){return}const d={preserveFocus:true,pinned:i.isPinned(s),sticky:i.isSticky(s),index:i.getIndexOfEditor(s),inactive:!i.isActive(s)};if(O(a.editor)){r.push({editor:s,replacement:a.editor,options:{...a.options,...d}})}else{r.push({editor:s,replacement:{...a.editor,options:{...a.editor.options,...d}}})}}if(r.length){this.replaceEditors(r,i)}}}onConfigurationUpdated(e){if(e&&!e.affectsConfiguration("workbench.editor.closeOnFileDelete")){return}const t=this.configurationService.getValue();if(typeof t.workbench?.editor?.closeOnFileDelete==="boolean"){this.closeOnFileDelete=t.workbench.editor.closeOnFileDelete}else{this.closeOnFileDelete=false}}handleDeletedFile(e,t,i){for(const r of this.getAllNonDirtyEditors({includeUntitled:false,supportSideBySide:true})){(async()=>{const s=r.resource;if(!s){return}if(this.closeOnFileDelete||!t){if(i&&this.uriIdentityService.extUri.isEqualOrParent(s,i)){return}let n=false;if(e instanceof we){n=e.contains(s,Ue.DELETED)}else{n=this.uriIdentityService.extUri.isEqualOrParent(s,e)}if(!n){return}let o=false;if(t&&this.fileService.hasProvider(s)){await xe(100);o=await this.fileService.exists(s)}if(!o&&!r.isDisposed()){r.dispose()}}})()}}getAllNonDirtyEditors(e){const t=[];function i(r){if(r.hasCapability(E.Untitled)&&!e.includeUntitled){return}if(r.isDirty()){return}t.push(r)}for(const r of this.editors){if(e.supportSideBySide&&r instanceof Q){i(r.primary);i(r.secondary)}else{i(r)}}return t}get activeEditorPane(){return this.editorGroupsContainer.activeGroup?.activeEditorPane}get activeTextEditorControl(){const e=this.activeEditorPane;if(e){const t=e.getControl();if(F(t)||N(t)){return t}if(We(t)&&F(t.activeCodeEditor)){return t.activeCodeEditor}}return void 0}get activeTextEditorLanguageId(){let e=void 0;const t=this.activeTextEditorControl;if(N(t)){e=t.getModifiedEditor()}else{e=t}return e?.getModel()?.getLanguageId()}get count(){return this.editorsObserver.count}get editors(){return this.getEditors(v.SEQUENTIAL).map(({editor:e})=>e)}getEditors(e,t){switch(e){case v.MOST_RECENTLY_ACTIVE:if(t?.excludeSticky){return this.editorsObserver.editors.filter(({groupId:i,editor:r})=>!this.editorGroupsContainer.getGroup(i)?.isSticky(r))}return this.editorsObserver.editors;case v.SEQUENTIAL:{const i=[];for(const r of this.editorGroupsContainer.getGroups(y.GRID_APPEARANCE)){i.push(...r.getEditors(v.SEQUENTIAL,t).map(s=>({editor:s,groupId:r.id})))}return i}}}get activeEditor(){const e=this.editorGroupsContainer.activeGroup;return e?e.activeEditor??void 0:void 0}get visibleEditorPanes(){return A(this.editorGroupsContainer.groups.map(e=>e.activeEditorPane))}get visibleTextEditorControls(){return this.doGetVisibleTextEditorControls(this.visibleEditorPanes)}doGetVisibleTextEditorControls(e){const t=[];for(const i of e){const r=[];if(i instanceof ke){r.push(i.getPrimaryEditorPane()?.getControl());r.push(i.getSecondaryEditorPane()?.getControl())}else{r.push(i.getControl())}for(const s of r){if(F(s)||N(s)){t.push(s)}}}return t}getVisibleTextEditorControls(e){return this.doGetVisibleTextEditorControls(A(this.editorGroupsContainer.getGroups(e===v.SEQUENTIAL?y.GRID_APPEARANCE:y.MOST_RECENTLY_ACTIVE).map(t=>t.activeEditorPane)))}get visibleEditors(){return A(this.editorGroupsContainer.groups.map(e=>e.activeEditor))}async openEditor(e,t,i){let r=void 0;let s=O(e)?t:e.options;let n=void 0;if(Pe(t)){i=t}if(!O(e)){const o=await this.editorResolverService.resolveEditor(e,i);if(o===L.ABORT){return}if(V(o)){r=o.editor;s=o.options;n=o.group}}if(!r){r=O(e)?e:await this.textEditorService.resolveTextEditor(e)}if(!n){let o=void 0;const a=this.instantiationService.invokeFunction(ne,{editor:r,options:s},i);if(a instanceof Promise){[n,o]=await a}else{[n,o]=a}if(o){s={...s,activation:o}}}return n.openEditor(r,s)}async openEditors(e,t,i){if(i?.validateTrust){const n=await this.handleWorkspaceTrust(e);if(!n){return[]}}const r=new Map;for(const n of e){let o=void 0;let a=void 0;if(!_(n)){const c=await this.editorResolverService.resolveEditor(n,t);if(c===L.ABORT){continue}if(V(c)){o=c;a=c.group}}if(!o){o=_(n)?n:{editor:await this.textEditorService.resolveTextEditor(n),options:n.options}}if(!a){const c=this.instantiationService.invokeFunction(ne,o,t);if(c instanceof Promise){[a]=await c}else{[a]=c}}let d=r.get(a);if(!d){d=[];r.set(a,d)}d.push(o)}const s=[];for(const[n,o]of r){s.push(n.openEditors(o))}return A(await B.settled(s))}async handleWorkspaceTrust(e){const{resources:t,diffMode:i,mergeMode:r}=this.extractEditorResources(e);const s=await this.workspaceTrustRequestService.requestOpenFilesTrust(t);switch(s){case H.Open:return true;case H.OpenInNewWindow:await this.hostService.openWindow(t.map(n=>({fileUri:n})),{forceNewWindow:true,diffMode:i,mergeMode:r});return false;case H.Cancel:return false}}extractEditorResources(e){const t=new Z;let i=false;let r=false;for(const s of e){if(_(s)){const n=k.getOriginalUri(s.editor,{supportSideBySide:D.BOTH});if(l.isUri(n)){t.add(n)}else if(n){if(n.primary){t.add(n.primary)}if(n.secondary){t.add(n.secondary)}i=s.editor instanceof pe}}else{if(ve(s)){if(l.isUri(s.input1)){t.add(s.input1.resource)}if(l.isUri(s.input2)){t.add(s.input2.resource)}if(l.isUri(s.base)){t.add(s.base.resource)}if(l.isUri(s.result)){t.add(s.result.resource)}r=true}if(Ee(s)){if(l.isUri(s.original.resource)){t.add(s.original.resource)}if(l.isUri(s.modified.resource)){t.add(s.modified.resource)}i=true}else if(Fe(s)){t.add(s.resource)}}}return{resources:Array.from(t.keys()),diffMode:i,mergeMode:r}}isOpened(e){return this.editorsObserver.hasEditor({resource:this.uriIdentityService.asCanonicalUri(e.resource),typeId:e.typeId,editorId:e.editorId})}isVisible(e){for(const t of this.editorGroupsContainer.groups){if(t.activeEditor?.matches(e)){return true}}return false}async closeEditor({editor:e,groupId:t},i){const r=this.editorGroupsContainer.getGroup(t);await r?.closeEditor(e,i)}async closeEditors(e,t){const i=new Map;for(const{editor:r,groupId:s}of e){const n=this.editorGroupsContainer.getGroup(s);if(!n){continue}let o=i.get(n);if(!o){o=[];i.set(n,o)}o.push(r)}for(const[r,s]of i){await r.closeEditors(s,t)}}findEditors(e,t,i){const r=l.isUri(e)?e:e.resource;const s=l.isUri(e)?void 0:e.typeId;if(t?.supportSideBySide!==D.ANY&&t?.supportSideBySide!==D.SECONDARY){if(!this.editorsObserver.hasEditors(r)){if(l.isUri(e)||ee(i)){return[]}return void 0}}if(!ee(i)){const n=typeof i==="number"?this.editorGroupsContainer.getGroup(i):i;if(l.isUri(e)){if(!n){return[]}return n.findEditors(r,t)}else{if(!n){return void 0}const o=n.findEditors(r,t);for(const a of o){if(a.typeId===s){return a}}return void 0}}else{const n=[];for(const o of this.editorGroupsContainer.getGroups(y.MOST_RECENTLY_ACTIVE)){const a=[];if(l.isUri(e)){a.push(...this.findEditors(e,t,o))}else{const d=this.findEditors(e,t,o);if(d){a.push(d)}}n.push(...a.map(d=>({editor:d,groupId:o.id})))}return n}}async replaceEditors(e,t){const i=typeof t==="number"?this.editorGroupsContainer.getGroup(t):t;const r=[];for(const s of e){let n=void 0;if(!O(s.replacement)){const o=await this.editorResolverService.resolveEditor(s.replacement,i);if(o===L.ABORT){continue}if(V(o)){n={editor:s.editor,replacement:o.editor,options:o.options,forceReplaceDirty:s.forceReplaceDirty}}}if(!n){n={editor:s.editor,replacement:te(s)?s.replacement:await this.textEditorService.resolveTextEditor(s.replacement),options:te(s)?s.options:s.replacement.options,forceReplaceDirty:s.forceReplaceDirty}}r.push(n)}return i?.replaceEditors(r)}async save(e,t){if(!Array.isArray(e)){e=[e]}const i=this.getUniqueEditors(e);const r=[];const s=[];if(t?.saveAs){s.push(...i)}else{for(const{groupId:o,editor:a}of i){if(a.hasCapability(E.Untitled)){s.push({groupId:o,editor:a})}else{r.push({groupId:o,editor:a})}}}const n=await B.settled(r.map(({groupId:o,editor:a})=>{if(t?.reason===p.EXPLICIT){this.editorGroupsContainer.getGroup(o)?.pinEditor(a)}return a.save(o,t)}));for(const{groupId:o,editor:a}of s){if(a.isDisposed()){continue}const d=await this.openEditor(a,o);const c={pinned:true,viewState:d?.getViewState()};const g=t?.saveAs?await a.saveAs(o,t):await a.save(o,t);n.push(g);if(!g){break}if(!a.matches(g)){const Oe=a.hasCapability(E.Untitled)?this.editorGroupsContainer.groups.map(I=>I.id):[o];for(const I of Oe){if(g instanceof Ne){await this.replaceEditors([{editor:a,replacement:g,options:c}],I)}else{await this.replaceEditors([{editor:a,replacement:{...g,options:c}}],I)}}}}return{success:n.every(o=>!!o),editors:A(n)}}saveAll(e){return this.save(this.getAllModifiedEditors(e),e)}async revert(e,t){if(!Array.isArray(e)){e=[e]}const i=this.getUniqueEditors(e);await B.settled(i.map(async({groupId:r,editor:s})=>{this.editorGroupsContainer.getGroup(r)?.pinEditor(s);return s.revert(r,t)}));return!i.some(({editor:r})=>r.isDirty())}async revertAll(e){return this.revert(this.getAllModifiedEditors(e),e)}getAllModifiedEditors(e){const t=[];for(const i of this.editorGroupsContainer.getGroups(y.MOST_RECENTLY_ACTIVE)){for(const r of i.getEditors(v.MOST_RECENTLY_ACTIVE)){if(!r.isModified()){continue}if((typeof e?.includeUntitled==="boolean"||!e?.includeUntitled?.includeScratchpad)&&r.hasCapability(E.Scratchpad)){continue}if(!e?.includeUntitled&&r.hasCapability(E.Untitled)){continue}if(e?.excludeSticky&&i.isSticky(r)){continue}t.push({groupId:i.id,editor:r})}}return t}getUniqueEditors(e){const t=[];for(const{editor:i,groupId:r}of e){if(t.some(s=>s.editor.matches(i))){continue}t.push({editor:i,groupId:r})}return t}dispose(){super.dispose();this.activeOutOfWorkspaceWatchers.forEach(e=>G(e));this.activeOutOfWorkspaceWatchers.clear()}};de=K=U([u(1,M),u(2,ge),u(3,Se),u(4,ue),u(5,Le),u(6,J),u(7,Ce),u(8,Ve),u(9,ye),u(10,Be)],de);let ce=class nt extends w{constructor(e,t,i,r,s){super();this.untitledTextEditorService=e;this.instantiationService=t;this.uriIdentityService=i;this.fileService=r;this.editorResolverService=s;this.editorInputCache=new m;this.fileEditorFactory=le.as(fe.EditorFactory).getFileEditorFactory();this.registerDefaultEditor()}registerDefaultEditor(){this._register(this.editorResolverService.registerEditor("*",{id:Y.id,label:Y.displayName,detail:Y.providerDisplayName,priority:He.builtin},{},{createEditorInput:e=>({editor:this.createTextEditor(e)}),createUntitledEditorInput:e=>({editor:this.createTextEditor(e)}),createDiffEditorInput:e=>({editor:this.createTextEditor(e)})}))}async resolveTextEditor(e){return this.createTextEditor(e)}createTextEditor(e){if(ve(e)){return this.createTextEditor(e.result)}if(Ee(e)){const r=this.createTextEditor(e.original);const s=this.createTextEditor(e.modified);return this.instantiationService.createInstance(pe,e.label,e.description,r,s,void 0)}if(Ye(e)){const r=this.createTextEditor(e.primary);const s=this.createTextEditor(e.secondary);return this.instantiationService.createInstance(Q,e.label,e.description,s,r)}const t=e;if(t.forceUntitled||!t.resource||t.resource.scheme===ie.untitled){const r={languageId:t.languageId,initialValue:t.contents,encoding:t.encoding};let s;if(t.resource?.scheme===ie.untitled){s=this.untitledTextEditorService.create({untitledResource:t.resource,...r})}else{s=this.untitledTextEditorService.create({associatedResource:t.resource,...r})}return this.createOrGetCached(s.resource,()=>this.instantiationService.createInstance(re,s))}const i=e;if(i.resource instanceof l){const r=i.label||qe(i.resource);const s=i.resource;const n=this.uriIdentityService.asCanonicalUri(s);return this.createOrGetCached(n,()=>{if(i.forceFile||this.fileService.hasProvider(n)){return this.fileEditorFactory.createFileEditor(n,s,i.label,i.description,i.encoding,i.languageId,i.contents,this.instantiationService)}return this.instantiationService.createInstance(se,n,i.label,i.description,i.languageId,i.contents)},o=>{if(o instanceof re){return}else if(!(o instanceof se)){o.setPreferredResource(s);if(i.label){o.setPreferredName(i.label)}if(i.description){o.setPreferredDescription(i.description)}if(i.encoding){o.setPreferredEncoding(i.encoding)}if(i.languageId){o.setPreferredLanguageId(i.languageId)}if(typeof i.contents==="string"){o.setPreferredContents(i.contents)}}else{if(r){o.setName(r)}if(i.description){o.setDescription(i.description)}if(i.languageId){o.setPreferredLanguageId(i.languageId)}if(typeof i.contents==="string"){o.setPreferredContents(i.contents)}}})}throw new Error(`ITextEditorService: Unable to create texteditor from ${JSON.stringify(e)}`)}createOrGetCached(e,t,i){let r=this.editorInputCache.get(e);if(r){i?.(r);return r}r=t();this.editorInputCache.set(e,r);$.once(r.onWillDispose)(()=>this.editorInputCache.delete(e));return r}};ce=U([u(0,Ke),u(1,ge),u(2,J),u(3,Se),u(4,Ce)],ce);let b=class at extends w{static{this.ID="workbench.contrib.editorAutoSave"}constructor(e,t,i,r,s,n,o,a){super();this.filesConfigurationService=e;this.hostService=t;this.editorService=i;this.editorGroupService=r;this.workingCopyService=s;this.logService=n;this.markerService=o;this.uriIdentityService=a;this.scheduledAutoSavesAfterDelay=new Map;this.lastActiveEditor=void 0;this.lastActiveGroupId=void 0;this.lastActiveEditorControlDisposable=this._register(new z);this.waitingOnConditionAutoSaveWorkingCopies=new m(d=>this.uriIdentityService.extUri.getComparisonKey(d));this.waitingOnConditionAutoSaveEditors=new m(d=>this.uriIdentityService.extUri.getComparisonKey(d));for(const d of this.workingCopyService.dirtyWorkingCopies){this.onDidRegister(d)}this.registerListeners()}registerListeners(){this._register(this.hostService.onDidChangeFocus(e=>this.onWindowFocusChange(e)));this._register(this.hostService.onDidChangeActiveWindow(()=>this.onActiveWindowChange()));this._register(this.editorService.onDidActiveEditorChange(()=>this.onDidActiveEditorChange()));this._register(this.filesConfigurationService.onDidChangeAutoSaveConfiguration(()=>this.onDidChangeAutoSaveConfiguration()));this._register(this.workingCopyService.onDidRegister(e=>this.onDidRegister(e)));this._register(this.workingCopyService.onDidUnregister(e=>this.onDidUnregister(e)));this._register(this.workingCopyService.onDidChangeDirty(e=>this.onDidChangeDirty(e)));this._register(this.workingCopyService.onDidChangeContent(e=>this.onDidChangeContent(e)));this._register(this.markerService.onMarkerChanged(e=>this.onConditionChanged(e,S.ERRORS)));this._register(this.filesConfigurationService.onDidChangeAutoSaveDisabled(e=>this.onConditionChanged([e],S.DISABLED)))}onConditionChanged(e,t){for(const i of e){const r=this.waitingOnConditionAutoSaveWorkingCopies.get(i);if(r?.condition===t){if(r.workingCopy.isDirty()&&this.filesConfigurationService.getAutoSaveMode(r.workingCopy.resource,r.reason).mode!==f.OFF){this.discardAutoSave(r.workingCopy);this.logService.trace(`[editor auto save] running auto save from condition change event`,r.workingCopy.resource.toString(),r.workingCopy.typeId);r.workingCopy.save({reason:r.reason})}}else{const s=this.waitingOnConditionAutoSaveEditors.get(i);if(s?.condition===t&&!s.editor.editor.isDisposed()&&s.editor.editor.isDirty()&&this.filesConfigurationService.getAutoSaveMode(s.editor.editor,s.reason).mode!==f.OFF){this.waitingOnConditionAutoSaveEditors.delete(i);this.logService.trace(`[editor auto save] running auto save from condition change event with reason ${s.reason}`);this.editorService.save(s.editor,{reason:s.reason})}}}}onWindowFocusChange(e){if(!e){this.maybeTriggerAutoSave(p.WINDOW_CHANGE)}}onActiveWindowChange(){this.maybeTriggerAutoSave(p.WINDOW_CHANGE)}onDidActiveEditorChange(){if(this.lastActiveEditor&&typeof this.lastActiveGroupId==="number"){this.maybeTriggerAutoSave(p.FOCUS_CHANGE,{groupId:this.lastActiveGroupId,editor:this.lastActiveEditor})}const e=this.editorGroupService.activeGroup;const t=this.lastActiveEditor=e.activeEditor??void 0;this.lastActiveGroupId=e.id;this.lastActiveEditorControlDisposable.clear();const i=this.editorService.activeEditorPane;if(t&&i){this.lastActiveEditorControlDisposable.add(i.onDidBlur(()=>{this.maybeTriggerAutoSave(p.FOCUS_CHANGE,{groupId:e.id,editor:t})}))}}maybeTriggerAutoSave(e,t){if(t){if(!t.editor.isDirty()||t.editor.isReadonly()||t.editor.hasCapability(E.Untitled)){return}const i=this.filesConfigurationService.getAutoSaveMode(t.editor,e);if(i.mode!==f.OFF){if(e===p.WINDOW_CHANGE&&(i.mode===f.ON_FOCUS_CHANGE||i.mode===f.ON_WINDOW_CHANGE)||e===p.FOCUS_CHANGE&&i.mode===f.ON_FOCUS_CHANGE){this.logService.trace(`[editor auto save] triggering auto save with reason ${e}`);this.editorService.save(t,{reason:e})}}else if(t.editor.resource&&(i.reason===S.ERRORS||i.reason===S.DISABLED)){this.waitingOnConditionAutoSaveEditors.set(t.editor.resource,{editor:t,reason:e,condition:i.reason})}}else{this.saveAllDirtyAutoSaveables(e)}}onDidChangeAutoSaveConfiguration(){let e=void 0;switch(this.filesConfigurationService.getAutoSaveMode(void 0).mode){case f.ON_FOCUS_CHANGE:e=p.FOCUS_CHANGE;break;case f.ON_WINDOW_CHANGE:e=p.WINDOW_CHANGE;break;case f.AFTER_SHORT_DELAY:case f.AFTER_LONG_DELAY:e=p.AUTO;break}if(e){this.saveAllDirtyAutoSaveables(e)}}saveAllDirtyAutoSaveables(e){for(const t of this.workingCopyService.dirtyWorkingCopies){if(t.capabilities&oe.Untitled){continue}const i=this.filesConfigurationService.getAutoSaveMode(t.resource,e);if(i.mode!==f.OFF){t.save({reason:e})}else if(i.reason===S.ERRORS||i.reason===S.DISABLED){this.waitingOnConditionAutoSaveWorkingCopies.set(t.resource,{workingCopy:t,reason:e,condition:i.reason})}}}onDidRegister(e){if(e.isDirty()){this.scheduleAutoSave(e)}}onDidUnregister(e){this.discardAutoSave(e)}onDidChangeDirty(e){if(e.isDirty()){this.scheduleAutoSave(e)}else{this.discardAutoSave(e)}}onDidChangeContent(e){if(e.isDirty()){this.scheduleAutoSave(e)}}scheduleAutoSave(e){if(e.capabilities&oe.Untitled){return}const t=this.filesConfigurationService.getAutoSaveConfiguration(e.resource).autoSaveDelay;if(typeof t!=="number"){return}this.discardAutoSave(e);this.logService.trace(`[editor auto save] scheduling auto save after ${t}ms`,e.resource.toString(),e.typeId);const i=setTimeout(()=>{this.discardAutoSave(e);if(e.isDirty()){const r=p.AUTO;const s=this.filesConfigurationService.getAutoSaveMode(e.resource,r);if(s.mode!==f.OFF){this.logService.trace(`[editor auto save] running auto save`,e.resource.toString(),e.typeId);e.save({reason:r})}else if(s.reason===S.ERRORS||s.reason===S.DISABLED){this.waitingOnConditionAutoSaveWorkingCopies.set(e.resource,{workingCopy:e,reason:r,condition:s.reason})}}},t);this.scheduledAutoSavesAfterDelay.set(e,ze(()=>{this.logService.trace(`[editor auto save] clearing pending auto save`,e.resource.toString(),e.typeId);clearTimeout(i)}))}discardAutoSave(e){G(this.scheduledAutoSavesAfterDelay.get(e));this.scheduledAutoSavesAfterDelay.delete(e);this.waitingOnConditionAutoSaveWorkingCopies.delete(e.resource);this.waitingOnConditionAutoSaveEditors.delete(e.resource)}};b=U([u(0,$e),u(1,ye),u(2,Qe),u(3,M),u(4,Je),u(5,je),u(6,Xe),u(7,J)],b);Ze(b.ID,b,et.BlockRestore);export{de as E,ce as T,ne as f};
