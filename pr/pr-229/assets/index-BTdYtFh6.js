class V extends Error{constructor(e,s){super(e),this.name="ParseError",this.type=s.type,this.field=s.field,this.value=s.value,this.line=s.line}}function A(t){}function et(t){if(typeof t=="function")throw new TypeError("`callbacks` must be an object, got a function instead. Did you mean `{onEvent: fn}`?");const{onEvent:e=A,onError:s=A,onRetry:i=A,onComment:l}=t;let r="",d=true,u,E="",f="";function $(a){const h=d?a.replace(/^\xEF\xBB\xBF/,""):a,[m,P]=st(`${r}${h}`);for(const D of m)W(D);r=P,d=false}function W(a){if(a===""){U();return}if(a.startsWith(":")){l&&l(a.slice(a.startsWith(": ")?2:1));return}const h=a.indexOf(":");if(h!==-1){const m=a.slice(0,h),P=a[h+1]===" "?2:1,D=a.slice(h+P);S(m,D,a);return}S(a,"",a)}function S(a,h,m){switch(a){case"event":f=h;break;case"data":E=`${E}${h}
`;break;case"id":u=h.includes("\0")?void 0:h;break;case"retry":/^\d+$/.test(h)?i(parseInt(h,10)):s(new V(`Invalid \`retry\` value: "${h}"`,{type:"invalid-retry",value:h,line:m}));break;default:s(new V(`Unknown field "${a.length>20?`${a.slice(0,20)}â€¦`:a}"`,{type:"unknown-field",field:a,value:h,line:m}));break}}function U(){E.length>0&&e({id:u,event:f||void 0,data:E.endsWith(`
`)?E.slice(0,-1):E}),u=void 0,E="",f=""}function T(a={}){r&&a.consume&&W(r),d=true,u=void 0,E="",f="",r=""}return{feed:$,reset:T}}function st(t){const e=[];let s="",i=0;for(;i<t.length;){const l=t.indexOf("\r",i),r=t.indexOf(`
`,i);let d=-1;if(l!==-1&&r!==-1?d=Math.min(l,r):l!==-1?d=l:r!==-1&&(d=r),d===-1){s=t.slice(i);break}else{const u=t.slice(i,d);e.push(u),i=d+1,t[i-1]==="\r"&&t[i]===`
`&&i++}}return[e,s]}class X extends Event{constructor(e,s){var i,l;super(e),this.code=(i=s==null?void 0:s.code)!=null?i:void 0,this.message=(l=s==null?void 0:s.message)!=null?l:void 0}[Symbol.for("nodejs.util.inspect.custom")](e,s,i){return i(Y(this),s)}[Symbol.for("Deno.customInspect")](e,s){return e(Y(this),s)}}function nt(t){const e=globalThis.DOMException;return typeof e=="function"?new e(t,"SyntaxError"):new SyntaxError(t)}function F(t){return t instanceof Error?"errors"in t&&Array.isArray(t.errors)?t.errors.map(F).join(", "):"cause"in t&&t.cause instanceof Error?`${t}: ${F(t.cause)}`:t.message:`${t}`}function Y(t){return{type:t.type,message:t.message,code:t.code,defaultPrevented:t.defaultPrevented,cancelable:t.cancelable,timeStamp:t.timeStamp}}var tt=t=>{throw TypeError(t)};var Q=(t,e,s)=>e.has(t)||tt("Cannot "+s);var n=(t,e,s)=>(Q(t,e,"read from private field"),s?s.call(t):e.get(t));var c=(t,e,s)=>e.has(t)?tt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s);var o=(t,e,s,i)=>(Q(t,e,"write to private field"),e.set(t,s),s);var w=(t,e,s)=>(Q(t,e,"access private method"),s);var p;var _;var y;var I;var R;var L;var b;var N;var g;var C;var k;var x;var M;var v;var B;var q;var H;var Z;var j;var z;var O;var J;var K;class G extends EventTarget{constructor(e,s){var i,l;super(),c(this,v),this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,c(this,p),c(this,_),c(this,y),c(this,I),c(this,R),c(this,L),c(this,b),c(this,N,null),c(this,g),c(this,C),c(this,k,null),c(this,x,null),c(this,M,null),c(this,q,async r=>{var d;n(this,C).reset();const{body:u,redirected:E,status:f,headers:$}=r;if(f===204){w(this,v,O).call(this,"Server sent HTTP 204, not reconnecting",204),this.close();return}if(E?o(this,y,new URL(r.url)):o(this,y,void 0),f!==200){w(this,v,O).call(this,`Non-200 status code (${f})`,f);return}if(!($.get("content-type")||"").startsWith("text/event-stream")){w(this,v,O).call(this,'Invalid content type, expected "text/event-stream"',f);return}if(n(this,p)===this.CLOSED)return;o(this,p,this.OPEN);const W=new Event("open");if((d=n(this,M))==null||d.call(this,W),this.dispatchEvent(W),typeof u!="object"||!u||!("getReader"in u)){w(this,v,O).call(this,"Invalid response body, expected a web ReadableStream",f),this.close();return}const S=new TextDecoder,U=u.getReader();let T=true;do{const{done:a,value:h}=await U.read();h&&n(this,C).feed(S.decode(h,{stream:!a})),a&&(T=false,n(this,C).reset(),w(this,v,J).call(this))}while(T)}),c(this,H,r=>{o(this,g,void 0),!(r.name==="AbortError"||r.type==="aborted")&&w(this,v,J).call(this,F(r))}),c(this,j,r=>{typeof r.id=="string"&&o(this,N,r.id);const d=new MessageEvent(r.event||"message",{data:r.data,origin:n(this,y)?n(this,y).origin:n(this,_).origin,lastEventId:r.id||""});n(this,x)&&(!r.event||r.event==="message")&&n(this,x).call(this,d),this.dispatchEvent(d)}),c(this,z,r=>{o(this,L,r)}),c(this,K,()=>{o(this,b,void 0),n(this,p)===this.CONNECTING&&w(this,v,B).call(this)});try{if(e instanceof URL)o(this,_,e);else if(typeof e=="string")o(this,_,new URL(e,it()));else throw new Error("Invalid URL")}catch{throw nt("An invalid or illegal string was specified")}o(this,C,et({onEvent:n(this,j),onRetry:n(this,z)})),o(this,p,this.CONNECTING),o(this,L,3e3),o(this,R,(i=s==null?void 0:s.fetch)!=null?i:globalThis.fetch),o(this,I,(l=s==null?void 0:s.withCredentials)!=null?l:false),w(this,v,B).call(this)}get readyState(){return n(this,p)}get url(){return n(this,_).href}get withCredentials(){return n(this,I)}get onerror(){return n(this,k)}set onerror(e){o(this,k,e)}get onmessage(){return n(this,x)}set onmessage(e){o(this,x,e)}get onopen(){return n(this,M)}set onopen(e){o(this,M,e)}addEventListener(e,s,i){const l=s;super.addEventListener(e,l,i)}removeEventListener(e,s,i){const l=s;super.removeEventListener(e,l,i)}close(){n(this,b)&&clearTimeout(n(this,b)),n(this,p)!==this.CLOSED&&(n(this,g)&&n(this,g).abort(),o(this,p,this.CLOSED),o(this,g,void 0))}}p=new WeakMap,_=new WeakMap,y=new WeakMap,I=new WeakMap,R=new WeakMap,L=new WeakMap,b=new WeakMap,N=new WeakMap,g=new WeakMap,C=new WeakMap,k=new WeakMap,x=new WeakMap,M=new WeakMap,v=new WeakSet,B=function(){o(this,p,this.CONNECTING),o(this,g,new AbortController),n(this,R)(n(this,_),w(this,v,Z).call(this)).then(n(this,q)).catch(n(this,H))},q=new WeakMap,H=new WeakMap,Z=function(){var t;const e={mode:"cors",redirect:"follow",headers:{Accept:"text/event-stream",...n(this,N)?{"Last-Event-ID":n(this,N)}:void 0},cache:"no-store",signal:(t=n(this,g))==null?void 0:t.signal};return"window"in globalThis&&(e.credentials=this.withCredentials?"include":"same-origin"),e},j=new WeakMap,z=new WeakMap,O=function(t,e){var s;n(this,p)!==this.CLOSED&&o(this,p,this.CLOSED);const i=new X("error",{code:e,message:t});(s=n(this,k))==null||s.call(this,i),this.dispatchEvent(i)},J=function(t,e){var s;if(n(this,p)===this.CLOSED)return;o(this,p,this.CONNECTING);const i=new X("error",{code:e,message:t});(s=n(this,k))==null||s.call(this,i),this.dispatchEvent(i),o(this,b,setTimeout(n(this,K),n(this,L)))},K=new WeakMap,G.CONNECTING=0,G.OPEN=1,G.CLOSED=2;function it(){const t="document"in globalThis?globalThis.document:void 0;return t&&typeof t=="object"&&"baseURI"in t&&typeof t.baseURI=="string"?t.baseURI:void 0}export{X as ErrorEvent,G as EventSource};
